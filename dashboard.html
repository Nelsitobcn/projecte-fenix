<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Projecte FÃ¨nix â€” Dashboard de Resultats</title>
<style>
:root{--green:#2ECC71;--yellow:#F39C12;--blue:#3498DB;--red:#E74C3C;--dark:#0A1628;--card:rgba(255,255,255,.07);--border:rgba(255,255,255,.13);--text:#fff;--muted:rgba(255,255,255,.55)}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',system-ui,sans-serif;background:linear-gradient(160deg,#0A1628,#0D1F3C,#0A1628);color:var(--text);min-height:100vh}

.top-bar{background:rgba(10,22,40,.95);padding:14px 24px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border);backdrop-filter:blur(12px);position:sticky;top:0;z-index:100}
.top-bar .logo{font-weight:800;font-size:1.1rem}
.top-bar .logo span{color:#E30613}
.top-bar .badge{background:var(--green);color:#fff;font-size:.7rem;font-weight:700;padding:4px 12px;border-radius:20px}
.top-bar .refresh{margin-left:auto;padding:8px 16px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:#fff;cursor:pointer;font-size:.85rem;font-family:inherit}
.top-bar .refresh:hover{background:rgba(255,255,255,.12)}

.container{max-width:1200px;margin:0 auto;padding:24px}
h1{font-size:1.6rem;margin-bottom:4px}
.subtitle{color:var(--muted);font-size:.9rem;margin-bottom:24px}

.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:28px}
@media(max-width:700px){.stats-row{grid-template-columns:repeat(2,1fr)}}
.stat-card{padding:20px;border-radius:14px;background:var(--card);border:1px solid var(--border)}
.stat-card .num{font-size:2rem;font-weight:800;line-height:1}
.stat-card .label{font-size:.78rem;color:var(--muted);margin-top:4px}

.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:28px}
@media(max-width:800px){.charts-grid{grid-template-columns:1fr}}
.chart-card{padding:24px;border-radius:14px;background:var(--card);border:1px solid var(--border)}
.chart-card h3{font-size:.95rem;margin-bottom:16px;display:flex;align-items:center;gap:8px}

.bar-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.bar-label{font-size:.8rem;min-width:120px;color:var(--muted)}
.bar-track{flex:1;height:20px;background:rgba(255,255,255,.06);border-radius:10px;overflow:hidden;position:relative}
.bar-fill{height:100%;border-radius:10px;transition:width .6s ease;min-width:2px}
.bar-val{font-size:.8rem;font-weight:700;min-width:35px;text-align:right}

.words-cloud{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;padding:12px 0}
.word-tag{padding:6px 14px;border-radius:20px;font-size:.85rem;border:1px solid var(--border);background:var(--card)}

.table-wrap{overflow-x:auto;margin-top:28px}
table{width:100%;border-collapse:collapse;font-size:.8rem}
th{text-align:left;padding:10px 12px;background:rgba(255,255,255,.05);color:var(--muted);font-weight:600;font-size:.7rem;text-transform:uppercase;letter-spacing:.05em;border-bottom:1px solid var(--border)}
td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.04)}

.empty-state{text-align:center;padding:60px 20px;color:var(--muted)}
.empty-state .icon{font-size:3rem;margin-bottom:12px}

.nav-links{display:flex;gap:10px;margin-top:28px;justify-content:center;flex-wrap:wrap}
.nav-links a{padding:10px 20px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:#fff;text-decoration:none;font-size:.85rem;transition:.2s}
.nav-links a:hover{background:rgba(255,255,255,.12)}
</style>
</head>
<body>

<div class="top-bar">
  <div class="logo">ğŸ”¥ <span>TMB</span>innova</div>
  <div style="font-size:.9rem;font-weight:600">ğŸ“Š Dashboard</div>
  <div class="badge" id="liveBadge">EN VIU</div>
  <button class="refresh" onclick="loadData()">ğŸ”„ Actualitzar</button>
</div>

<div class="container">
  <h1>Resultats de ValidaciÃ³ â€” TMB Day</h1>
  <div class="subtitle">Dades recollides en temps real des del formulari de validaciÃ³. <span id="lastUpdate"></span></div>

  <!-- STATS ROW -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="num" id="totalResponses" style="color:var(--green)">0</div>
      <div class="label">Respostes recollides</div>
    </div>
    <div class="stat-card">
      <div class="num" id="targetPct" style="color:var(--blue)">0%</div>
      <div class="label">Objectiu (16 conductors)</div>
    </div>
    <div class="stat-card">
      <div class="num" id="avgCAD" style="color:var(--yellow)">â€”</div>
      <div class="label">Comoditat espais (P8 mitja)</div>
    </div>
    <div class="stat-card">
      <div class="num" id="positiveReaction" style="color:var(--green)">0%</div>
      <div class="label">ReacciÃ³ positiva al FÃ¨nix</div>
    </div>
  </div>

  <!-- CHARTS -->
  <div class="charts-grid">
    <!-- P1: Fatiga -->
    <div class="chart-card">
      <h3>ğŸ˜© P1 â€” Nivell de fatiga habitual</h3>
      <div id="chartFatiga"></div>
    </div>

    <!-- P5: ReacciÃ³ al concepte -->
    <div class="chart-card">
      <h3>ğŸ’¡ P5 â€” ReacciÃ³ al concepte FÃ¨nix</h3>
      <div id="chartReaccio"></div>
    </div>

    <!-- P6: Zona preferida -->
    <div class="chart-card">
      <h3>ğŸ¯ P6 â€” Zona preferida</h3>
      <div id="chartZona"></div>
    </div>

    <!-- P7: Barreres -->
    <div class="chart-card">
      <h3>ğŸš§ P7 â€” Principal barrera</h3>
      <div id="chartBarrera"></div>
    </div>

    <!-- P9: Repetiria? -->
    <div class="chart-card">
      <h3>ğŸ”„ P9 â€” RepetirÃ­es l'Ãºs?</h3>
      <div id="chartRepetir"></div>
    </div>

    <!-- P10: Paraules -->
    <div class="chart-card">
      <h3>ğŸ’¬ P10 â€” Paraules que defineixen el FÃ¨nix</h3>
      <div class="words-cloud" id="wordCloud"></div>
    </div>
  </div>

  <!-- P2: Torns -->
  <div class="charts-grid">
    <div class="chart-card">
      <h3>â˜€ï¸ P2 â€” DistribuciÃ³ per torn</h3>
      <div id="chartTorn"></div>
    </div>
    <div class="chart-card">
      <h3>ğŸ“… P3 â€” Antiguitat a TMB</h3>
      <div id="chartAnys"></div>
    </div>
  </div>

  <!-- RAW DATA TABLE -->
  <div class="chart-card" style="margin-top:8px">
    <h3 style="display:flex;align-items:center;justify-content:space-between;">
      ğŸ“‹ Totes les respostes
      <button onclick="exportCSV()" style="padding:8px 16px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:#fff;cursor:pointer;font-size:.8rem;font-family:inherit">ğŸ“¥ Exportar CSV</button>
    </h3>
    <div class="table-wrap" id="rawTable"></div>
  </div>

  <!-- RECORDINGS INFO -->
  <div class="chart-card" style="margin-top:20px;">
    <h3>ğŸ™ï¸ Gravacions d'entrevistes</h3>
    <div id="recordingsInfo" style="font-size:.85rem;color:var(--muted)">Carregant...</div>
  </div>

  <div class="nav-links">
    <a href="index.html">ğŸ”¥ Prototip</a>
    <a href="formulari.html">ğŸ“ Formulari</a>
    <a href="entrevista_semiestructurada.html">ğŸ“‹ Entrevista</a>
  </div>
</div>

<script>
const STORAGE = 'fenix_validacio_v2';
const COLORS = {green:'#2ECC71',yellow:'#F39C12',blue:'#3498DB',red:'#E74C3C',purple:'#9B59B6',gray:'#95A5A6'};

function loadData() {
  const data = JSON.parse(localStorage.getItem(STORAGE) || '[]');
  const n = data.length;

  // Stats
  document.getElementById('totalResponses').textContent = n;
  document.getElementById('targetPct').textContent = Math.round(n / 16 * 100) + '%';
  document.getElementById('lastUpdate').textContent = n > 0 ? 'Ãšltima resposta: ' + new Date(data[n-1].timestamp).toLocaleTimeString('ca') : '';

  if (n === 0) {
    document.querySelectorAll('.chart-card div[id^="chart"]').forEach(el => {
      el.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“­</div><p>Encara no hi ha dades.<br>ComenÃ§a a recollir respostes amb el <a href="formulari.html" style="color:var(--green)">formulari</a>.</p></div>';
    });
    document.getElementById('avgCAD').textContent = 'â€”';
    document.getElementById('positiveReaction').textContent = '0%';
    document.getElementById('rawTable').innerHTML = '<p style="text-align:center;padding:20px;color:var(--muted)">Sense dades</p>';
    return;
  }

  // P8 average
  const p8vals = data.filter(d => d.p8).map(d => Number(d.p8));
  const avgP8 = p8vals.length > 0 ? (p8vals.reduce((a,b) => a+b, 0) / p8vals.length).toFixed(1) : 'â€”';
  document.getElementById('avgCAD').textContent = avgP8 + '/5';

  // Positive reaction %
  const positive = data.filter(d => d.p5 === 'Molt positiva' || d.p5 === 'Positiva amb dubtes').length;
  document.getElementById('positiveReaction').textContent = Math.round(positive / n * 100) + '%';

  // Charts
  renderBars('chartFatiga', countField(data, 'p1'), [COLORS.green, COLORS.green, COLORS.yellow, COLORS.red, COLORS.red]);
  renderBars('chartReaccio', countField(data, 'p5'), [COLORS.green, COLORS.yellow, COLORS.gray, COLORS.red]);
  renderBars('chartZona', countField(data, 'p6'), [COLORS.green, COLORS.yellow, COLORS.blue]);
  renderBars('chartBarrera', countField(data, 'p7'), [COLORS.yellow, COLORS.purple, COLORS.red, COLORS.green]);
  renderBars('chartRepetir', countField(data, 'p9'), [COLORS.green, COLORS.blue, COLORS.gray, COLORS.red]);
  renderBars('chartTorn', countField(data, 'p2'), [COLORS.yellow, COLORS.blue, COLORS.purple, COLORS.green]);
  renderBars('chartAnys', countField(data, 'p3'), [COLORS.blue, COLORS.green, COLORS.yellow]);

  // Word cloud
  const words = data.map(d => d.p10_paraula).filter(w => w && w.trim());
  const wc = document.getElementById('wordCloud');
  if (words.length > 0) {
    const wordCount = {};
    words.forEach(w => { const k = w.trim().toLowerCase(); wordCount[k] = (wordCount[k]||0) + 1; });
    wc.innerHTML = Object.entries(wordCount)
      .sort((a,b) => b[1] - a[1])
      .map(([w, c]) => {
        const size = Math.min(1.4, 0.8 + c * 0.15);
        return '<div class="word-tag" style="font-size:' + size + 'rem;border-color:' + COLORS.green + '">' + w + (c > 1 ? ' <small>x' + c + '</small>' : '') + '</div>';
      }).join('');
  } else {
    wc.innerHTML = '<span style="color:var(--muted)">Encara cap paraula</span>';
  }

  // Raw table
  const fields = ['conductor_id','p1','p2','p3','p5','p6','p7','p8','p9','p10_paraula'];
  const headers = ['ID','Fatiga','Torn','Anys','ReacciÃ³','Zona','Barrera','CAD','Repetir','Paraula'];
  let html = '<table><thead><tr>' + headers.map(h => '<th>' + h + '</th>').join('') + '</tr></thead><tbody>';
  data.forEach((r, i) => {
    html += '<tr>' + fields.map(f => '<td>' + (r[f] || 'â€”') + '</td>').join('') + '</tr>';
  });
  html += '</tbody></table>';
  document.getElementById('rawTable').innerHTML = html;

  // Recordings
  const recs = JSON.parse(localStorage.getItem('fenix_recordings_meta') || '[]');
  const recInfo = document.getElementById('recordingsInfo');
  if (recs.length > 0) {
    recInfo.innerHTML = '<p>ğŸ™ï¸ <strong>' + recs.length + '</strong> entrevistes gravades</p>' +
      recs.map((r, i) => '<div style="margin-top:8px;padding:8px 12px;background:rgba(255,255,255,.04);border-radius:8px;border:1px solid var(--border);">#' + (i+1) + ' â€” <strong>' + r.conductor + '</strong> Â· ' + Math.floor(r.duration/60) + ':' + String(r.duration%60).padStart(2,'0') + ' min Â· ' + new Date(r.timestamp).toLocaleString('ca') + '</div>').join('');
  } else {
    recInfo.innerHTML = 'Cap gravaciÃ³ registrada.';
  }
}

function countField(data, field) {
  const counts = {};
  data.forEach(d => {
    const v = d[field] || 'Sense resposta';
    counts[v] = (counts[v] || 0) + 1;
  });
  return counts;
}

function renderBars(containerId, counts, colors) {
  const el = document.getElementById(containerId);
  const max = Math.max(...Object.values(counts), 1);
  const entries = Object.entries(counts);
  el.innerHTML = entries.map(([label, val], i) => {
    const pct = Math.round(val / max * 100);
    const color = colors[i % colors.length];
    return '<div class="bar-row">' +
      '<div class="bar-label">' + label + '</div>' +
      '<div class="bar-track"><div class="bar-fill" style="width:' + pct + '%;background:' + color + '"></div></div>' +
      '<div class="bar-val">' + val + '</div></div>';
  }).join('');
}

function exportCSV() {
  const data = JSON.parse(localStorage.getItem(STORAGE) || '[]');
  if (!data.length) { alert('No hi ha dades.'); return; }
  const fields = ['id','conductor_id','timestamp','p1','p2','p3','p4','p5','p6','p7','p8','p9','p10_paraula','p11_comentari'];
  const header = fields.join(',');
  const rows = data.map(r => fields.map(f => '"' + String(r[f] || '').replace(/"/g,'""') + '"').join(','));
  const csv = '\ufeff' + header + '\n' + rows.join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'fenix_resultats_' + new Date().toISOString().slice(0,10) + '.csv';
  a.click();
}

// Auto-refresh every 10 seconds
loadData();
setInterval(loadData, 10000);
</script>
</body>
</html>
